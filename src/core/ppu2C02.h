#ifndef PPU2C02_H
#define PPU2C02_H

#include <Arduino.h>
#include <stdint.h>

#include "cartridge.h"

#define BUFFER_SIZE 256 + 8 + 8
#define SCANLINE_SIZE 256
#define SCANLINES_PER_BUFFER 10
#define TILES_PER_SCANLINE 32
#define PIXELS_PER_TILE 8

class Bus;
class Ppu2C02
{
public:
    Ppu2C02();
    ~Ppu2C02();

public:
    void ppuWrite(uint16_t addr, uint8_t data);
    uint8_t ppuRead(uint16_t addr);
    void cpuWrite(uint16_t addr, uint8_t data);
    uint8_t cpuRead(uint16_t addr);

    void renderScanline(uint16_t scanline);
    void fakeSpriteHit(uint16_t scanline);
    void setVBlank();
    void clearVBlank();
    void reset();

    void connectBus(Bus* n) { bus = n; }
    void connectCartridge(Cartridge* cartridge);
    void setMirror(Cartridge::MIRROR mirror);
    Cartridge::MIRROR getMirror();

    void dumpState(File& state);
    void loadState(File& state);
private:
    Cartridge* cart = nullptr;
    Bus* bus = nullptr;

    void renderBackground();
    void renderSprites(uint16_t scanline);
    void transferScroll(uint16_t scanline);
    void incrementY();
    void finishScanline(uint16_t scanline);
    uint16_t scanline_buffer[BUFFER_SIZE];
    uint8_t scanline_metadata[BUFFER_SIZE];
    static uint16_t display_buffer[SCANLINE_SIZE * SCANLINES_PER_BUFFER];
    uint8_t nametable[2048];
    uint8_t* ptr_nametable[4];
    uint8_t palette_table[32];
    uint8_t scanline_counter = 0;

    // NTSC888 Palette in RGB565
    static constexpr uint16_t palette_NTSC565[8][64] = 
    {
        {
            0x630C, 0x00F2, 0x1835, 0x4013, 0x600D, 0x6804, 0x6020, 0x48E0,
            0x21A0, 0x0240, 0x0260, 0x0242, 0x01AB, 0x0000, 0x0000, 0x0000,
            0xAD55, 0x0A7B, 0x397F, 0x70BE, 0x9857, 0xB08C, 0xA920, 0x8A20,
            0x5320, 0x23E0, 0x0440, 0x0406, 0x0372, 0x0000, 0x0000, 0x0000,
            0xFFFF, 0x553F, 0x843F, 0xB37F, 0xDB1F, 0xFB18, 0xFBAD, 0xDC84,
            0xB560, 0x8640, 0x56A4, 0x3E8D, 0x3E19, 0x4A69, 0x0000, 0x0000,
            0xFFFF, 0xBF1F, 0xCEBF, 0xE65F, 0xF63F, 0xFE3D, 0xFE59, 0xF6B5,
            0xE6F3, 0xD753, 0xC775, 0xB778, 0xB75C, 0xBDD7, 0x0000, 0x0000,
        },
        {
            0x6228, 0x004E, 0x1810, 0x400F, 0x5809, 0x6801, 0x6000, 0x4880,
            0x2140, 0x01A0, 0x01C0, 0x0180, 0x00E7, 0x0000, 0x0000, 0x0000,
            0xAC10, 0x1195, 0x40B9, 0x7018, 0x9812, 0xA828, 0xA0C0, 0x89A0,
            0x5A80, 0x2320, 0x0340, 0x0303, 0x026D, 0x0000, 0x0000, 0x0000,
            0xFE7A, 0x5BFD, 0x831F, 0xB27F, 0xE21C, 0xF233, 0xF2C8, 0xDB80,
            0xB460, 0x8520, 0x5D60, 0x4549, 0x44D4, 0x51A5, 0x0000, 0x0000,
            0xFE7A, 0xC59A, 0xCD3D, 0xE4FD, 0xF4DB, 0xFCD8, 0xFCF4, 0xF550,
            0xE58E, 0xD5EE, 0xC610, 0xBE13, 0xBDF7, 0xBC71, 0x0000, 0x0000,
        },
        {
            0x3AE6, 0x00CE, 0x0010, 0x200E, 0x3808, 0x4800, 0x4020, 0x28E0,
            0x09A0, 0x0220, 0x0260, 0x0220, 0x0188, 0x0000, 0x0000, 0x0000,
            0x7D0D, 0x0235, 0x1959, 0x4897, 0x7050, 0x8086, 0x7920, 0x6220,
            0x3300, 0x0BC0, 0x0420, 0x03E2, 0x032D, 0x0000, 0x0000, 0x0000,
            0xC795, 0x34DB, 0x5BFF, 0x8B3F, 0xAAD9, 0xC2F0, 0xC366, 0xAC40,
            0x8540, 0x5600, 0x2E60, 0x1E48, 0x1DB2, 0x2A44, 0x0000, 0x0000,
            0xC795, 0x8E97, 0x9E39, 0xADF9, 0xBDD7, 0xC5D4, 0xC5F0, 0xBE4C,
            0xAEAA, 0x9EEA, 0x8F0C, 0x870F, 0x86F3, 0x856E, 0x0000, 0x0000,
        },
        {
            0x4225, 0x004C, 0x080E, 0x280D, 0x4007, 0x4800, 0x4000, 0x2880,
            0x0920, 0x01A0, 0x01C0, 0x0160, 0x00E7, 0x0000, 0x0000, 0x0000,
            0x840C, 0x0194, 0x20B7, 0x5015, 0x700F, 0x8025, 0x80C0, 0x61A0,
            0x3A60, 0x0B00, 0x0340, 0x0302, 0x026C, 0x0000, 0x0000, 0x0000,
            0xCE55, 0x3BFA, 0x631E, 0x925D, 0xB218, 0xCA2F, 0xC2A5, 0xB380,
            0x8C60, 0x5D00, 0x3540, 0x2527, 0x24B1, 0x31A3, 0x0000, 0x0000,
            0xCE55, 0x9576, 0xA518, 0xB4D8, 0xC4B7, 0xCCB3, 0xCCEF, 0xC52C,
            0xB58A, 0xA5CA, 0x95EC, 0x8DEF, 0x8DD3, 0x8C6E, 0x0000, 0x0000,
        },
        {
            0x4A4F, 0x0073, 0x1016, 0x3014, 0x500E, 0x5805, 0x4800, 0x3060,
            0x0900, 0x0180, 0x01C0, 0x0184, 0x012D, 0x0000, 0x0000, 0x0000,
            0x8C58, 0x01DD, 0x30FF, 0x603F, 0x8018, 0x900D, 0x88A2, 0x6960,
            0x3A40, 0x0B00, 0x0340, 0x0329, 0x02B4, 0x0001, 0x0000, 0x0000,
            0xD6BF, 0x443F, 0x6B5F, 0x9ABF, 0xC23F, 0xD25A, 0xD2CF, 0xB387,
            0x8C62, 0x6522, 0x3D88, 0x2591, 0x2D1C, 0x39AC, 0x0000, 0x0000,
            0xD6BF, 0x9DDF, 0xA57F, 0xBD3F, 0xCD1F, 0xD51F, 0xD53C, 0xCD78,
            0xBDD6, 0xAE36, 0x9E58, 0x965B, 0x8E3F, 0x94B9, 0x0000, 0x0000,
        },
        {
            0x49E9, 0x002E, 0x1011, 0x300F, 0x480A, 0x5003, 0x4800, 0x3040,
            0x08E0, 0x0140, 0x0160, 0x0141, 0x00C8, 0x0000, 0x0000, 0x0000,
            0x8BB1, 0x0157, 0x309A, 0x6019, 0x8012, 0x9009, 0x8860, 0x6940,
            0x3A20, 0x0AA0, 0x02E0, 0x02C5, 0x022F, 0x0000, 0x0000, 0x0000,
            0xD5FB, 0x439E, 0x6ADF, 0x9A1F, 0xB9DD, 0xD1F4, 0xCA6A, 0xB322,
            0x8C00, 0x64A0, 0x3CE3, 0x24EC, 0x2C76, 0x3947, 0x0000, 0x0000,
            0xD5FB, 0x9D1C, 0xACDE, 0xBC7E, 0xCC5C, 0xD459, 0xD495, 0xCCD2,
            0xBD30, 0xAD70, 0x9D91, 0x9595, 0x9579, 0x9413, 0x0000, 0x0000,
        },
        {
            0x3A29, 0x006F, 0x0011, 0x200F, 0x3809, 0x4001, 0x3800, 0x2060,
            0x0100, 0x0180, 0x01A0, 0x0182, 0x0109, 0x0000, 0x0000, 0x0000,
            0x7410, 0x01B7, 0x18DA, 0x4838, 0x6811, 0x7808, 0x70A0, 0x5960,
            0x2A40, 0x0300, 0x0340, 0x0325, 0x028F, 0x0000, 0x0000, 0x0000,
            0xB679, 0x2C1D, 0x533F, 0x827F, 0xA23B, 0xBA32, 0xBAA9, 0xA380,
            0x7C60, 0x4D00, 0x2D62, 0x154B, 0x14D5, 0x29A7, 0x0000, 0x0000,
            0xB679, 0x859B, 0x8D3C, 0xA4FC, 0xACDB, 0xBCD7, 0xBCF3, 0xB550,
            0xA5AE, 0x95EE, 0x8610, 0x7E13, 0x7DD7, 0x7C72, 0x0000, 0x0000,
        },
        {
            0x39E7, 0x002D, 0x000F, 0x200D, 0x4008, 0x4801, 0x4000, 0x2840,
            0x08E0, 0x0140, 0x0160, 0x0140, 0x00C8, 0x0000, 0x0000, 0x0000,
            0x73AE, 0x0155, 0x2098, 0x4816, 0x7010, 0x8006, 0x7880, 0x5940,
            0x3220, 0x02C0, 0x02E0, 0x02C3, 0x022D, 0x0000, 0x0000, 0x0000,
            0xBDF7, 0x339B, 0x5ADF, 0x8A1F, 0xA9D9, 0xB9F1, 0xBA67, 0xA320,
            0x7C00, 0x54A0, 0x2D01, 0x1CEA, 0x1C53, 0x2965, 0x0000, 0x0000,
            0xBDF7, 0x8518, 0x94BA, 0xA47A, 0xB459, 0xBC55, 0xBC91, 0xB4CE,
            0xA52C, 0x956C, 0x858E, 0x7D91, 0x7D55, 0x8410, 0x0000, 0x0000,
        },
    };
    const uint16_t (*nes_palette)[64] = palette_NTSC565;
    static constexpr uint8_t palette_mirror[32] =
    {
        0x00,0x01,0x02,0x03, 0x04,0x05,0x06,0x07,
        0x08,0x09,0x0A,0x0B, 0x0C,0x0D,0x0E,0x0F,
        0x00,0x11,0x12,0x13, 0x04,0x15,0x16,0x17,
        0x08,0x19,0x1A,0x1B, 0x0C,0x1D,0x1E,0x1F
    };

    // PPU Registers
    // PPUCTRL
    union
    {
        struct
        {
            uint8_t nametable_x : 1;
            uint8_t nametable_y : 1;
            uint8_t VRAM_addr_increment : 1;
            uint8_t sprite_table_addr : 1;
            uint8_t background_table_addr : 1;
            uint8_t sprite_size : 1;
            uint8_t PPU_master_select : 1;
            uint8_t Vblank_NMI : 1;
        };
        uint8_t reg = 0x00;
    } control;

    // PPUMASK
    union
    {
        struct
        {
            uint8_t grayscale : 1;
            uint8_t render_background_left : 1;
            uint8_t render_sprite_left : 1;
            uint8_t render_background : 1;
            uint8_t render_sprite : 1;
            uint8_t emphasize : 3;
        };
        uint8_t reg = 0x00;
    } mask;

    // PPUSTATUS
    union
    {
        struct
        {
            uint8_t unused : 5;
            uint8_t sprite_overflow : 1;
            uint8_t sprite_zero_hit : 1;
            uint8_t VBlank : 1;
        };
        uint8_t reg = 0x00;
    } status;

    // OAMADDR
    uint8_t OAMADDR = 0x00;
    // OAMDATA
    uint8_t OAMDATA = 0x00;

    // Internal register 
    typedef union
    {
        struct
        {
            uint16_t coarse_x : 5;
            uint16_t coarse_y : 5;
            uint16_t nametable_x : 1;
            uint16_t nametable_y : 1;
            uint16_t fine_y: 3;
            uint16_t unused : 1;
        };
        uint16_t reg = 0x00;
    } internal_register;

    // OAM
    typedef struct
    {
        uint8_t y;
        uint8_t index;
        uint8_t attribute;
        uint8_t x;
    } OAM;

    OAM sprite[64];
    internal_register v;
    internal_register t;
    uint8_t x;
    uint8_t w;
    uint8_t PPUDATA_buffer = 0x00;

    // Rendering
    uint16_t offset = 0x0000;
    uint8_t nametable_index = 0x00;
    uint16_t nametable_byte_base = 0x00;
    uint16_t attribute_byte_base = 0x00;
    uint8_t nametable_byte = 0x00;
    uint8_t attribute_byte = 0x00;
    uint8_t x_tile = 0x00;
    uint8_t y_tile = 0x00;
    uint8_t attribute_shift = 0x00;
    uint8_t attribute = 0x00;
    uint8_t tile_index = 0x00;
    uint8_t* ptr_tile = nullptr;
    uint8_t* ptr_attribute = nullptr;
    uint8_t* ptr_pattern_tile = nullptr;
    uint8_t* ptr_scanline_meta = nullptr;

    uint8_t sprite_count = 0;
public:
    uint8_t* ptr_sprite = (uint8_t*)sprite;
    uint16_t* ptr_buffer = scanline_buffer;
    static constexpr uint16_t* ptr_display = display_buffer;
};

#endif